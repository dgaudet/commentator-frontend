<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authenticating...</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f5f5f5;
      }
      .container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e0e0e0;
        border-top-color: #3d8bff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .error {
        max-width: 500px;
        padding: 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .error h2 {
        margin-top: 0;
        color: #d32f2f;
      }
      .error p {
        color: #666;
        margin: 0.5rem 0;
      }
      .error a {
        display: inline-block;
        margin-top: 1rem;
        padding: 0.75rem 1.5rem;
        background: #3d8bff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-weight: 600;
      }
      .error a:hover {
        background: #2b7fff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="content">
        <div class="spinner"></div>
      </div>
    </div>
    <script>
      /**
       * IMPORTANT: The logic in this file mirrors src/utils/callbackHandler.ts
       *
       * These functions are comprehensively tested in src/__tests__/callbackHandler.test.ts
       * The test file imports the actual TypeScript module and validates:
       * - Parameter parsing and validation (OAuth2)
       * - XSS prevention through HTML escaping
       * - Dynamic base path detection
       * - Error handling and user-friendly messaging
       * - SessionStorage management
       *
       * When updating these functions, ensure src/utils/callbackHandler.ts is updated
       * and tests are run to maintain code synchronization.
       */

      // Escape HTML to prevent XSS attacks (matches callbackHandler.escapeHtml)
      function esc(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;',
        }
        return text.replace(/[&<>"']/g, (c) => map[c])
      }

      // Detect base path by removing /callback/ from pathname (matches callbackHandler.getBasePath)
      function getBase() {
        const pathname = window.location.pathname
        const normalized = pathname.endsWith('/') ? pathname : pathname + '/'
        return normalized.replace(/\/callback\/$/, '/') || '/'
      }

      // Parse callback parameters from URL search params (matches callbackHandler.parseCallbackParams)
      function parse() {
        const searchParams = new URLSearchParams(window.location.search)
        return {
          code: searchParams.get('code'),
          state: searchParams.get('state'),
          error: searchParams.get('error'),
          desc: searchParams.get('error_description'),
        }
      }

      // Validate callback parameters (matches callbackHandler.validateCallbackParams)
      function validate(params) {
        const hasError = params.error !== null
        const hasAuthCode = params.code !== null && params.state !== null

        if (hasError) {
          return { ok: false, type: 'error', err: params.error, desc: params.desc }
        }

        if (!hasAuthCode) {
          return { ok: false, type: 'invalid', err: 'missing', desc: 'Missing code or state' }
        }

        return { ok: true }
      }

      // Get user-friendly error message (matches callbackHandler.getErrorMessage)
      function getMsg(errorCode) {
        const messages = {
          access_denied: 'Login cancelled. Please try again.',
          server_error: 'Authentication service error. Please try again later.',
          unauthorized_client: 'Application configuration error. Please contact support.',
        }
        return messages[errorCode] || 'An error occurred during authentication.'
      }

      // Display error HTML (matches callbackHandler.formatErrorHtml)
      function showError(errorCode, hasDetails) {
        const container = document.getElementById('content')
        const message = getMsg(errorCode)
        const basePath = getBase()
        const codeDisplay = hasDetails ? `<p style="font-size:0.85rem;color:#999;">Code: ${esc(errorCode)}</p>` : ''

        container.innerHTML = `<div class="error">
          <h2>Authentication Error</h2>
          <p>${esc(message)}</p>
          ${codeDisplay}
          <a href="${esc(basePath)}">Return to Application</a>
        </div>`
      }

      // Main callback handler
      function handleCallback() {
        console.log('=== Auth0 Callback Handler Started ===')
        console.log('Current URL:', window.location.href)
        console.log('Current pathname:', window.location.pathname)
        console.log('Current search:', window.location.search)

        try {
          // 1. Parse parameters
          console.log('Step 1: Parsing callback parameters...')
          const params = parse()
          console.log('Parsed parameters:', {
            hasCode: !!params.code,
            hasState: !!params.state,
            hasError: !!params.error,
            errorCode: params.error,
          })

          // 2. Validate parameters
          console.log('Step 2: Validating parameters...')
          const validation = validate(params)
          console.log('Validation result:', validation)

          if (!validation.ok) {
            console.error('‚ùå Callback validation failed')
            console.error('Validation details:', validation)
            showError(validation.err, validation.desc)
            return
          }

          console.log('‚úÖ Parameters validated successfully')

          // 3. Store callback processed flag in sessionStorage
          console.log('Step 3: Storing callback flag in sessionStorage...')
          const callbackData = {
            t: Date.now(),
            ok: true,
          }
          sessionStorage.setItem('auth0_callback_processed', JSON.stringify(callbackData))
          console.log('‚úÖ Callback flag stored')

          // 4. Clean URL and redirect
          console.log('Step 4: Preparing redirect...')
          const basePath = getBase()
          console.log('Base path detected:', basePath)
          console.log('Cleaned URL will be:', basePath)

          window.history.replaceState(null, '', basePath)
          console.log('‚úÖ URL cleaned via history.replaceState')

          // Brief delay to allow history update before navigation
          console.log('Step 5: Redirecting to application...')
          setTimeout(() => {
            console.log('üîÑ Redirecting to:', basePath)
            window.location.replace(basePath)
          }, 100)
        } catch (e) {
          console.error('‚ùå Callback handler error:', e)
          console.error('Error stack:', e instanceof Error ? e.stack : 'N/A')
          showError('error', e instanceof Error ? e.message : 'Unknown error')
        }
      }

      // Execute handler
      console.log('Auth0 Callback handler script loaded')
      handleCallback()
    </script>
  </body>
</html>
